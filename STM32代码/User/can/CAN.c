#include "CAN.h"
#include "stm32f10x.h" 
#include "bsp_usart.h"
#include <string.h>
CanRxMsg CANRXMSG_1;
CanRxMsg CANRXMSG_2;
CanRxMsg CANRXMSG_3;
CanRxMsg CANRXMSG_4;
CanRxMsg CANRXMSG_5;
CanRxMsg CANRXMSG_6;
CanRxMsg CANRXMSG_7;
CanRxMsg CANRXMSG_8;
uint8_t volatile MESTRUCT_flag_5;
uint8_t volatile MESTRUCT_flag_6;
uint8_t volatile MESTRUCT_flag_7;
uint8_t volatile MESTRUCT_flag_8;
uint8_t volatile MESTRUCT_flag_9;
uint8_t volatile MESTRUCT_flag_10;
uint8_t volatile MESTRUCT_flag_11;
uint8_t volatile MESTRUCT_flag_12;

#define		PID0E					(0x0e)			//µã»ðÌáÇ°½Ç
#define		PID1F					(0x1f)			//·¢¶¯»úÆô¶¯Ê±¼ä
#define		PID23					(0x23)			//ÓÍ¹ìÑ¹Á¦
#define		PID2F					(0x2f)			//Ê£ÓàÓÍÁ¿
#define		PID49					(0x49)			//¼ÓËÙÌ¤°åÎ»ÖÃD
#define		PID5A					(0x5a)			//Ïà¶Ô¼ÓËÙÌ¤°åÎ»ÖÃ
#define		PID5C					(0x6c)			//·¢¶¯»ú»úÓÍÎÂ¶È
#define		PID5D					(0x5d)			//È¼ÓÍÅçÉäÕýÊ±½Ç
#define		PID5E					(0x5e)			//È¼ÓÍÏûºÄÂÊ
#define		PID83					(0x83)			//NOx´«¸ÐÆ÷

//OBDdataType OBDdata[20]=
//{
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID04,"LOAD_PCT",Engineload_Formula},				//0				·¢¶¯»ú¸ºÔØ
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID05,"ECT",Coolant_temperature_Formula},		//1				ÀäÈ´ÒºÎÂ¶È
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID06,"SHRTFT1",SHRTFT1_Formula},						//2				¶ÌÆÚÈ¼ÓÍÐÞÕý
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID07,"LONGFT1",LONGFT1_Formula},						//3				³¤Ê±È¼ÓÍÐÞÕý
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID0B,"MAP",Intake_abspressure},						//				½øÆøÆç¹Ü¾ø¶ÔÑ¹Á¦
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID0C,"RPM",RPM_Formula},										//3				·¢¶¯»ú×ªËÙ
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID0D,"VSS",Speed_Formula},									//4				³µËÙ
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID0F,"IAT",Intake_airtmep},								//5				½øÆøÆç¹Ü¿ÕÆøÎÂ¶È
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID10,"MAF",Airflow_Formula},								//6				½øÆøÁ÷Á¿
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID11,"TP",Throttle_position},							//7				½ÚÆøÃÅ¿ª¶È
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID0E,"SPARKADV",SPARKADV_Formula},				//7				µã»ðÌáÇ°½Ç
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID1F,"RUNTM",RUNTM_Formula},				//7				·¢¶¯»úÆô¶¯Ê±¼ä
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID23,"FRP",FRP_Formula},				//7				µã»ðÌáÇ°½Ç
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID2F,"FLI",FLI_Formula},				//7				µã»ðÌáÇ°½Ç
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID49,"APP_D",APP_D_Formula},				//7				µã»ðÌáÇ°½Ç
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID5A,"APP_R",APP_R_Formula},				//7				µã»ðÌáÇ°½Ç
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID5C,"EOT",EOT_Formula},				//7				µã»ðÌáÇ°½Ç
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID5D,"FUEL_TIMING",FUEL_TIMING_Formula},				//7				µã»ðÌáÇ°½Ç
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID5E,"FUEL_RATE",FUEL_RATE_Formula},				//7				µã»ðÌáÇ°½Ç
//	{CAN_Id_Standard,0x7df,0x0000,ServiceID01,PID83,"NOx",NOx_Formula},				//7				µã»ðÌáÇ°½Ç	
//};

//char OBDdataHz_1[20]={	1,1,1,1,1,
//												1,1,1,1,1,
//												1,1,1,1,1,
//												1,1,1,1,1,};

void Command_Formula(void* OBDdatadef, CanRxMsg tempCANRxMSG,cJSON * root){
	cJSON * Arry;
	OBDdataTypeNew *OBDdata=(OBDdataTypeNew *)OBDdatadef;
	int num=OBDdata->datanum;
	int numarry[num];
	int i=0;
	if(tempCANRxMSG.Data[1]!=(OBDdata->SID|0x40)||tempCANRxMSG.Data[2]!=OBDdata->PID){
		printf("%s resolve error!\r\n",OBDdata->dataname);
		printf("tempCANRxMSG.Data[1]:%#x  tempCANRxMSG.Data[2]:%#x\r\n",tempCANRxMSG.Data[1],tempCANRxMSG.Data[2]);
	}	
	for(i=0;i<num;i++){
		numarry[i]=tempCANRxMSG.Data[3+i];
	}
	Arry=cJSON_CreateIntArray(numarry,OBDdata->datanum);
	cJSON_AddItemToObject(root,OBDdata->dataname,Arry);
	return;
}

uint8_t  numofask=23 ;
OBDdataTypeNew newOBDdata[25]=
{//0x7df
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID01,1,"DTC_CNT",Command_Formula},
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID04,1,"LOAD_PCT",Command_Formula},				//0				·¢¶¯»ú¸ºÔØ
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID05,1,"ECT",Command_Formula},		//1				ÀäÈ´ÒºÎÂ¶È
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID06,1,"SHRTFT1",Command_Formula},						//2				¶ÌÆÚÈ¼ÓÍÐÞÕý
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID07,1,"LONGFT1",Command_Formula},						//3				³¤Ê±È¼ÓÍÐÞÕý
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID0A,1,"FP",Command_Formula},				//7				ÓÍ¹ìÑ¹Á¦(±íÑ¹)
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID0B,2,"MAP",Command_Formula},						//				½øÆøÆç¹Ü¾ø¶ÔÑ¹Á¦
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID0C,2,"RPM",Command_Formula},										//3				·¢¶¯»ú×ªËÙ
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID0D,1,"VSS",Command_Formula},									//4				³µËÙ
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID0F,1,"IAT",Command_Formula},								//5				½øÆøÆç¹Ü¿ÕÆøÎÂ¶È
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID10,2,"MAF",Command_Formula},								//6				½øÆøÁ÷Á¿
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID11,1,"TP",Command_Formula},							//7				½ÚÆøÃÅ¿ª¶È
	{CAN_Id_Standard,0x7e8,0x18DB33F1,ServiceID01,PID0E,1,"SPARKADV",Command_Formula},				//7				µã»ðÌáÇ°½Ç
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID1F,2,"RUNTM",Command_Formula},				//7				·¢¶¯»úÆô¶¯Ê±¼ä
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID23,2,"FRP",Command_Formula},				//7				µã»ðÌáÇ°½Ç
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID2F,1,"FLI",Command_Formula},				//7				µã»ðÌáÇ°½Ç
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID49,1,"APP_D",Command_Formula},				//7				µã»ðÌáÇ°½Ç
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID5A,1,"APP_R",Command_Formula},				//7				µã»ðÌáÇ°½Ç
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID5C,1,"EOT",Command_Formula},				//7				µã»ðÌáÇ°½Ç
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID5D,2,"FUEL_TIMING",Command_Formula},				//7				µã»ðÌáÇ°½Ç
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID5E,2,"FUEL_RATE",Command_Formula},				//7				µã»ðÌáÇ°½Ç
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID01,PID83,2,"NOx",Command_Formula},				//7				µã»ðÌáÇ°½
	{CAN_Id_Standard,0x7df,0x18DB33F1,ServiceID03,PID01,2,"DCTs",Command_Formula},
};


char OBDdataHz_new[25]={	1,1,1,1,1,
													1,1,1,1,1,
													1,1,1,1,1,
													1,1,1,1,1,
													1,1,1,1,1,
																		};

int sum_OBDdataHz_new(char *arry,char size){
	int i=0;
	int sum=0;
	for(i=0;i<size;i++){
		sum+=arry[i];
	}
	return sum;
}
extern QueueHandle_t CANmsg_Queue;

static void CAN1_NVICConfig(void)
{
		NVIC_InitTypeDef       NVIC_InitStructure;

			/* CAN1 Enabling interrupt */		
		//NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);//ÉèÖÃÓÅÏÈ¼¶·Ö×é Ñ¡Ôñ×é2  2Î»ÇÀÕ¼Ê½ÓÅÏÈ¼¶ 2
		NVIC_InitStructure.NVIC_IRQChannel=USB_LP_CAN1_RX0_IRQn;//Ñ¡ÔñÖÐ¶ÏÔ´£¨´ýÐÞ¸Ä£©
		NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 6;
		//NVIC_InitStructure.NVIC_IRQChannelSubPriority = 3;
		NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
		NVIC_Init(&NVIC_InitStructure);			
}

/**************************************************************************************************************
  CAN1 Config    CAN1_RX PA11  CAN1_TX  PA12
  FIFO_0	  
 * º¯ÊýÃû£ºCAN1_Config
 * ÃèÊö  £ºCAN1µÄ³õÊ¼»¯»¯
 * ÊäÈë  £ºsjw£ºÍ¬²½ÌøÔ¾¿í¶È£¬Ò»°ã¶¨ÒåÎª1
					 bs1£ºÊ±¼ä¶Î1.ÓÉ´«²¥¶ÎºÍÏàÎ»»º³å¶Î1Ò²¾ÍÊÇPROP_SEGºÍPHASE_SEG1×é³É
					 bs2£»ÏàÎ»»º³å¶Î2¼´PHASE_SEG2
					 pres£º·ÖÆµÏµÊý£¬ABH1µÄÆµÂÊÎª36M
 * Êä³ö  : ÎÞ
 * ±¸×¢  £ºCAN1²¨ÌØÂÊ¼ÆËã
*****************************************************************************************************************/
void CAN1_Config(uint32_t Baud)
{
		GPIO_InitTypeDef       GPIO_InitStructure;
		CAN_InitTypeDef        CAN_InitStructure;
		CAN_FilterInitTypeDef  CAN_FilterInitStructure;
		int Prescaler = (1000/Baud)*4;
		

		/* ´ò¿ªGPIOÊ±ÖÓ¡¢AFIOÊ±ÖÓ£¬CANÊ±ÖÓ */
		RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA | RCC_APB2Periph_AFIO, ENABLE);
		RCC_APB1PeriphClockCmd(RCC_APB1Periph_CAN1, ENABLE);


		/* CAN1 RX PB8 */
		GPIO_InitStructure.GPIO_Pin = GPIO_Pin_11;
		GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;//ÉÏÀ­ÊäÈë
		GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
		GPIO_Init(GPIOA, &GPIO_InitStructure);
		/* CAN1 TX PB9 */
		GPIO_InitStructure.GPIO_Pin = GPIO_Pin_12;
		GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;//¸´ÓÃÍÆÍìÊä³ö
		GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
		GPIO_Init(GPIOA, &GPIO_InitStructure);

//		GPIO_PinRemapConfig(GPIO_Remap1_CAN1,ENABLE);  // CAN1 remap
									
		/* CAN  BaudRate = RCC_APB1PeriphClock/(CAN_SJW+CAN_BS1+CAN_BS2)/CAN_Prescaler */
		CAN_DeInit(CAN1);
		CAN_StructInit(&CAN_InitStructure);   
		CAN_InitStructure.CAN_TTCM=DISABLE;              //MCR-TTCM  ¹Ø±ÕÊ±¼ä´¥·¢Í¨ÐÅÄ£Ê½Ê¹ÄÜ
		CAN_InitStructure.CAN_ABOM=DISABLE;              //MCR-ABOM  ×Ô¶¯ÀëÏß¹ÜÀí
		CAN_InitStructure.CAN_AWUM=DISABLE;              //MCR-AWUM  Ê¹ÓÃ×Ô¶¯»½ÐÑÄ£Ê½
		CAN_InitStructure.CAN_NART=DISABLE;              //MCR-NART  ½ûÖ¹±¨ÎÄ×Ô¶¯ÖØ´«	  DISABLE-×Ô¶¯ÖØ´«              
		CAN_InitStructure.CAN_RFLM=DISABLE;              //MCR-RFLM  ½ÓÊÕFIFO Ëø¶¨Ä£Ê½  DISABLE-Òç³öÊ±ÐÂ±¨ÎÄ»á¸²¸ÇÔ­ÓÐ±¨ÎÄ
		CAN_InitStructure.CAN_TXFP=DISABLE;              //MCR-TXFP  ·¢ËÍFIFOÓÅÏÈ¼¶ DISABLE-ÓÅÏÈ¼¶È¡¾öÓÚ±¨ÎÄ±êÊ¾·û
		CAN_InitStructure.CAN_Mode=CAN_Mode_Normal;   
		//CAN_InitStructure.CAN_Mode=CAN_Mode_LoopBack;
		CAN_InitStructure.CAN_SJW=CAN_SJW_1tq;                   //CAN_InitStructure.CAN_SJW=CAN_SJW_2tq; BTR-SJW ÖØÐÂÍ¬²½ÌøÔ¾¿í¶È 2¸öÊ±¼äµ¥Ôª
		
	/* ss=1 bs1=5 bs2=3 Î»Ê±¼ä¿í¶ÈÎª(1+5+3) ²¨ÌØÂÊ¼´ÎªÊ±ÖÓÖÜÆÚtq*(1+3+5)  */		
		CAN_InitStructure.CAN_BS1=CAN_BS1_5tq;           //CAN_InitStructure.CAN_BS1= CAN_BS1_5tq;//BTR-TS1 Ê±¼ä¶Î1 Õ¼ÓÃÁË5¸öÊ±¼äµ¥Ôª  
		CAN_InitStructure.CAN_BS2=CAN_BS2_3tq;           //CAN_InitStructure.CAN_BS2=CAN_BS2_3tq;//BTR-TS1 Ê±¼ä¶Î2 Õ¼ÓÃÁË3¸öÊ±¼äµ¥Ôª
  /* CAN Baudrate = 1 MBps (1MBpsÒÑÎªstm32µÄCAN×î¸ßËÙÂÊ) (CAN Ê±ÖÓÆµÂÊÎª APB1 = 36 MHz) */
	
//		CAN_InitStructure.CAN_Prescaler =4;		 //BTR-BRP ²¨ÌØÂÊ·ÖÆµÆ÷  ¶¨ÒåÁËÊ±¼äµ¥ÔªµÄÊ±¼ä³¤¶È 36/(1+5+3)/4=1 Mbps
//		CAN_InitStructure.CAN_Prescaler =32;

		CAN_InitStructure.CAN_Prescaler =Prescaler;


//CAN_InitStructure.CAN_Prescaler=pres;
		CAN_Init(CAN1,&CAN_InitStructure);	// CAN1											

/*
 * º¯ÊýÃû£ºCAN_Filter_Config
 * ÃèÊö  £ºCANµÄ¹ýÂËÆ÷ ÅäÖÃ*/

		CAN_FilterInitStructure.CAN_FilterNumber=0;	 
		CAN_FilterInitStructure.CAN_FilterMode=CAN_FilterMode_IdMask;	 // ±êÊ¶·ûÆÁ±ÎÎ»Ä£Ê½
		CAN_FilterInitStructure.CAN_FilterScale=CAN_FilterScale_32bit;   // 32Î»¹ýÂËÆ÷
		CAN_FilterInitStructure.CAN_FilterIdHigh=0x0000;			// ¹ýÂËÆ÷±êÊ¶·û
		CAN_FilterInitStructure.CAN_FilterIdLow=0x0000;				
		CAN_FilterInitStructure.CAN_FilterMaskIdHigh=0x0000;		// ¹ýÂËÆ÷ÆÁ±Î±êÊ¶·û
		CAN_FilterInitStructure.CAN_FilterMaskIdLow=0x0000;
		CAN_FilterInitStructure.CAN_FilterFIFOAssignment=CAN_FIFO0;	 // FIFO0Ö¸Ïò¹ýÂËÆ÷
		CAN_FilterInitStructure.CAN_FilterActivation=ENABLE;
		CAN_FilterInit(&CAN_FilterInitStructure);
		CAN1_NVICConfig();
		CAN_ITConfig(CAN1,CAN_IT_FMP0,ENABLE);  // CAN1
}

void CANinit(uint32_t Baud){
	//CAN1_NVICConfig();
	CAN1_Config(Baud);
	return;
}


void USB_LP_CAN1_RX0_IRQHandler()
{
	portBASE_TYPE xHigherPriorityTaskWoken = pdFALSE;
	CanRxMsg tempCANMSG;
	
	if( CAN_GetITStatus(CAN1, CAN_IT_FMP0) != RESET )
	{
		CAN_Receive(CAN1, CAN_FIFO0, &tempCANMSG);
		xQueueSendFromISR( CANmsg_Queue, &tempCANMSG, &xHigherPriorityTaskWoken );
	}	
	CAN_ClearITPendingBit(CAN1, CAN_IT_FMP0);
	portEND_SWITCHING_ISR( xHigherPriorityTaskWoken );
}


void CANTransmit_frame(uint32_t Id,  uint8_t IDE, uint8_t *data,uint8_t datalen){
	CanTxMsg tempCANTxMSG;
	if(IDE==CAN_Id_Standard){
		tempCANTxMSG.StdId=Id;
	}else{
		tempCANTxMSG.ExtId=Id;
	}
	tempCANTxMSG.IDE=IDE;
	tempCANTxMSG.RTR=CAN_RTR_Data;
	tempCANTxMSG.DLC=8;
	for(int i=0;i<datalen;i++){
		tempCANTxMSG.Data[i]=data[i];
	}	
	CAN_Transmit(CAN1, &tempCANTxMSG);
	return;
}


void OBDTransmit_askframe(uint32_t Id,  uint8_t IDE, uint8_t SID,uint8_t PID){
	CanTxMsg tempCANTxMSG;
	memset(&tempCANTxMSG,0x00,sizeof(CanTxMsg));
	if(IDE==CAN_Id_Standard){
		tempCANTxMSG.StdId=Id;
	}else{
		tempCANTxMSG.ExtId=0x18DB33F1;
	}
	tempCANTxMSG.IDE=IDE;
	tempCANTxMSG.RTR=CAN_RTR_Data;
	tempCANTxMSG.DLC=8;
	tempCANTxMSG.Data[0]=02;
	tempCANTxMSG.Data[1]=SID;
	tempCANTxMSG.Data[2]=PID;
	
	CAN_Transmit(CAN1, &tempCANTxMSG);
	return;
}
void AddOBDdata_to_json(char *retarr,uint8_t VSS,uint32_t RPM,float TP,float LOAD_PCT,uint8_t MAP,float MAF,uint64_t timestamp){
		char *retchar=NULL;
    cJSON * root =  cJSON_CreateObject();
	
		cJSON_AddItemToObject(root, "VSS",cJSON_CreateNumber(VSS));//Ìí¼Óname½Úµã
    cJSON_AddItemToObject(root, "RPM",cJSON_CreateNumber(RPM) );//¸ù½ÚµãÏÂÌí¼Ó
    cJSON_AddItemToObject(root, "TP", cJSON_CreateNumber(TP));
    cJSON_AddItemToObject(root, "LOAD_PCT",cJSON_CreateNumber(LOAD_PCT));
    cJSON_AddItemToObject(root, "MAP",cJSON_CreateNumber(MAP));
    cJSON_AddItemToObject(root, "MAF", cJSON_CreateNumber(MAF));//root½ÚµãÏÂÌí¼Ósemantic½Úµã
    cJSON_AddItemToObject(root, "timestamp", cJSON_CreateNumber(timestamp));//semantic½ÚµãÏÂÌí¼Óitem½Úµã

 
		retchar= cJSON_Print(root);
		printf("strlen(retchar):%d\r\n",strlen(retchar));
    printf("%s\n", retchar);;
		strcpy(retarr, retchar);
		cJSON_Delete(root);
		vPortFree(retchar);
		printf("xPortGetFreeHeapSize():%d\r\n",xPortGetFreeHeapSize());
		
		return;
}

void Speed_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[2];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x0D){
		printf("Speed_Formula error!\r\n");
	}

//	*(uint8_t *)ret=tempCANRxMSG.Data[3];
	numarry[0]=tempCANRxMSG.Data[3];
	Arry=cJSON_CreateIntArray(numarry,1);
	cJSON_AddItemToObject(root,"VSS",Arry);
	return ;
}


void RPM_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	//CanRxMsg tempCANTxMSG;
	cJSON * Arry;
	int numarry[2];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x0C){
		printf("RPM_Formula error!\r\n");
	}

//	*(uint32_t *)ret=(tempCANRxMSG.Data[3]*256+tempCANRxMSG.Data[4])>>2;	

	numarry[0]=tempCANRxMSG.Data[3];
	numarry[1]=tempCANRxMSG.Data[4];
	Arry=cJSON_CreateIntArray(numarry,2);
	cJSON_AddItemToObject(root,"PRM",Arry);
	return;
}


void Engineload_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[2];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x04){
		printf("LOAD_PCT error!\r\n");
	}

//	*(float *)ret=(float)tempCANRxMSG.Data[3]*100/255;

	numarry[0]=tempCANRxMSG.Data[3];
	Arry=cJSON_CreateIntArray(numarry,1);
	cJSON_AddItemToObject(root,"LOAD_PCT",Arry);
	return;
}

void  Coolant_temperature_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	//CanRxMsg tempCANTxMSG;
	cJSON * Arry;
	int numarry[1];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x05){
		printf("ECT error!\r\n");
	}

//	*(float *)ret=(float)tempCANRxMSG.Data[3]-40;

	numarry[0]=tempCANRxMSG.Data[3];
	Arry=cJSON_CreateIntArray(numarry,1);
	cJSON_AddItemToObject(root,"ECT",Arry);
	return;
}

void SHRTFT1_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[1];
	
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x06){
		printf("SHRTFT1 error!r\n");
	}
//*(float *)ret=((float)tempCANRxMSG.Data[3]-128)/128;
	numarry[0]=tempCANRxMSG.Data[3];
	Arry=cJSON_CreateIntArray(numarry,1);
	cJSON_AddItemToObject(root,"SHRTFT1",Arry);
	return;
}

void LONGFT1_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[1];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x07){
		printf("LONGFT1 error!\r\n");
	}
//*(float *)ret=((float)tempCANRxMSG.Data[3]-128)/128;
	numarry[0]=tempCANRxMSG.Data[3];
	Arry=cJSON_CreateIntArray(numarry,1);
	cJSON_AddItemToObject(root,"LONGFT1",Arry);
	return;
}

void  Airflow_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	//CanRxMsg tempCANTxMSG;
	cJSON * Arry;
	int numarry[2];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x10){
		printf("MAF error!\r\n");
	}
//	*(float *)ret=((float)tempCANRxMSG.Data[3]*256+(float)tempCANRxMSG.Data[4])/100;
	numarry[0]=tempCANRxMSG.Data[3];
	numarry[1]=tempCANRxMSG.Data[4];
	Arry=cJSON_CreateIntArray(numarry,2);
	cJSON_AddItemToObject(root,"ECT",Arry);
	return;
}


void  Intake_abspressure(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[2];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x0B){
		printf("MAP error!\r\n");
	}
//	*(uint8_t *)ret=tempCANRxMSG.Data[3];
	numarry[0]=tempCANRxMSG.Data[3];
	numarry[1]=tempCANRxMSG.Data[4];
	Arry=cJSON_CreateIntArray(numarry,2);
	cJSON_AddItemToObject(root,"MAP",Arry);
	return;
}

void  Throttle_position(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){

	cJSON * Arry;
	int numarry[1];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x11){
		printf("TP error!\r\n");
	}

//	*(float *)ret=(float)tempCANRxMSG.Data[3]*100/255;
	numarry[0]=tempCANRxMSG.Data[3];
	Arry=cJSON_CreateIntArray(numarry,1);
	cJSON_AddItemToObject(root,"TP",Arry);
	return;
}

void  Intake_airtmep(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[1];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x0f){
		printf("IAT error!\r\n");
	}

//	*(float *)ret=(float)tempCANRxMSG.Data[3]-40;
	numarry[0]=tempCANRxMSG.Data[3];
	Arry=cJSON_CreateIntArray(numarry,1);
	cJSON_AddItemToObject(root,"IAT",Arry);
	return;
}
//			µã»ðÌáÇ°½Ç
void  SPARKADV_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[1];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x0E){
		printf("SPARKADV error!\r\n");
	}

//	*(float *)ret=((float)tempCANRxMSG.Data[3]-128)/2;//(DATA[0]-128)/2	
	numarry[0]=tempCANRxMSG.Data[3];
	Arry=cJSON_CreateIntArray(numarry,1);
	cJSON_AddItemToObject(root,"SPARKADV",Arry);
	return;
}

//7				·¢¶¯»úÆô¶¯Ê±¼ä
void  RUNTM_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[2];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x1F){
		printf("RUNTM error!\r\n");
	}

//	*(float *)ret=((float)tempCANRxMSG.Data[3]*256+tempCANRxMSG.Data[4];//DATA[0]*256+DATA[1]
	numarry[0]=tempCANRxMSG.Data[3];
	numarry[1]=tempCANRxMSG.Data[4];
	Arry=cJSON_CreateIntArray(numarry,2);
	cJSON_AddItemToObject(root,"RUNTM",Arry);
	return;
}

//ÓÍ¹ìÑ¹Á¦
void  FRP_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[2];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x23){
		printf("FRP error!\r\n");
	}

//	*(float *)ret=tempCANRxMSG.Data[3]*256+tempCANRxMSG.Data[4];//DATA[0]*256+DATA[1]
	numarry[0]=tempCANRxMSG.Data[3];
	numarry[1]=tempCANRxMSG.Data[4];
	Arry=cJSON_CreateIntArray(numarry,2);
	cJSON_AddItemToObject(root,"FRP",Arry);
	return;
}

//Ê£ÓàÓÍÁ¿
void  FLI_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[1];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x2F){
		printf("FLI error!\r\n");
	}

//	*(float *)ret=(float)(tempCANRxMSG.Data[3]*100)/255;//DATA[0]*100/255
	numarry[0]=tempCANRxMSG.Data[3];
	Arry=cJSON_CreateIntArray(numarry,1);
	cJSON_AddItemToObject(root,"FLI",Arry);
	return;
}

//¼ÓËÙÌ¤°åÎ»ÖÃD
void  APP_D_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[1];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x49){
		printf("APP_D error!\r\n");
	}

//	*(float *)ret=(float)(tempCANRxMSG.Data[3]*100)/255;//DATA[0]*100/255
	numarry[0]=tempCANRxMSG.Data[3];
	Arry=cJSON_CreateIntArray(numarry,1);
	cJSON_AddItemToObject(root,"APP_D",Arry);
	return;
}

//Ïà¶Ô¼ÓËÙÌ¤°åÎ»ÖÃ
void  APP_R_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[1];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x5A){
		printf("APP_R error!\r\n");
	}

//	*(float *)ret=(float)(tempCANRxMSG.Data[3]*100)/255;//DATA[0]*100/255
	numarry[0]=tempCANRxMSG.Data[3];
	Arry=cJSON_CreateIntArray(numarry,1);
	cJSON_AddItemToObject(root,"APP_R",Arry);
	return;
}

//»úÓÍÎÂ¶È
void  EOT_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[1];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x5C){
		printf("EOT error!\r\n");
	}

//	*(float *)ret=tempCANRxMSG.Data[3]-40;//DATA[0]-40	
	numarry[0]=tempCANRxMSG.Data[3];
	Arry=cJSON_CreateIntArray(numarry,1);
	cJSON_AddItemToObject(root,"EOT",Arry);
	return;
}
//È¼ÓÍÅçÉäÕýÊ±½Ç
void  FUEL_TIMING_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[2];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x5D){
		printf("FUEL_TIMING error!\r\n");
	}

//	*(float *)ret=((float)(tempCANRxMSG.Data[3]*256+tempCANRxMSG.Data[3]-26880))/128;//(DATA[0]*256+DATA[1]-26880)/128	
	numarry[0]=tempCANRxMSG.Data[3];
	numarry[1]=tempCANRxMSG.Data[4];
	Arry=cJSON_CreateIntArray(numarry,2);
	cJSON_AddItemToObject(root,"FUEL_TIMING",Arry);
	return;
}

//È¼ÓÍÏûºÄÂÊ
void  FUEL_RATE_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[2];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x5E){
		printf("FUEL_RATE error!\r\n");
	}

//	*(float *)ret=((float)(tempCANRxMSG.Data[3]*256+tempCANRxMSG.Data[3]))*0.05;(DATA[0]*256+DATA[1])*0.05
	numarry[0]=tempCANRxMSG.Data[3];
	numarry[1]=tempCANRxMSG.Data[4];
	Arry=cJSON_CreateIntArray(numarry,2);
	cJSON_AddItemToObject(root,"FUEL_RATE",Arry);
	return;
}

//NOx
void  NOx_Formula(CanRxMsg tempCANRxMSG,void *ret,cJSON * root){
	cJSON * Arry;
	int numarry[2];
	if(tempCANRxMSG.Data[1]!=0x41||tempCANRxMSG.Data[2]!=0x83){
		printf("NOx error!\r\n");
	}

//	*(float *)ret=((float)(tempCANRxMSG.Data[3]*256+tempCANRxMSG.Data[3]))*0.05;(DATA[0]*256+DATA[1])*0.05
	numarry[0]=tempCANRxMSG.Data[3];
	numarry[1]=tempCANRxMSG.Data[4];
	Arry=cJSON_CreateIntArray(numarry,2);
	cJSON_AddItemToObject(root,"NOx",Arry);
	return;
}



